# ANPR-System-v0.3

Десктопное приложение для детекции и распознавания автомобильных номеров с локальной базой событий и настраиваемыми каналами.

## Установка

```bash
pip install -r requirements.txt
```

> Для CPU-окружения PyTorch можно установить через официальный индекс: `pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0 --index-url https://download.pytorch.org/whl/cpu`.

## Быстрый старт

```bash
python app.py
```

- Вкладка **«Наблюдение»** — выбор сетки (1×1, 1×2, 2×2, 2×3, 3×3), окно каналов на 3/4 ширины, под ним «Последнее событие», справа подробности выбранного события и таблица последних распознаваний. Потоки каналов стартуют автоматически при запуске приложения и после сохранения источника/RTSP в настройках, дополнительная кнопка не требуется.
- Вкладка **«Поиск»** — поиск по номеру и интервалу времени.
- Вкладка **«Настройки»** — разделена на вкладки «Общие» (автопереподключение, пути, сетка по умолчанию) и «Каналы» (источники, ROI, распознавание, детектор движения), чтобы параметры приложения и конкретных потоков не смешивались; здесь же настраиваются числа бестшотов для консенсусного распознавания, пауза подавления повторов и параметры движения (частота анализа, минимальное число кадров для включения/выключения распознавания, порог движения).

## Алгоритмы и архитектура

┌─────────────────────────────────────────────┐
│ Presentation Layer (GUI/CLI)                │  ← main_window.py, app.py, anpr_cli.py
├─────────────────────────────────────────────┤
│ Application Layer (Coordinators)            │  ← channel_worker.py, factory.py
├─────────────────────────────────────────────┤
│ Domain Layer (Core Business Logic)          │  ← anpr_pipeline.py, aggregator.py
├─────────────────────────────────────────────┤
│ Infrastructure Layer (External Services)    │  ← yolo_detector.py, crnn_recognizer.py
└─────────────────────────────────────────────┘

### Слои приложения
- **UI-слой** (`anpr/ui/main_window.py`) управляет вкладками, пользовательскими действиями и жизненным циклом потоков.
- **Асинхронные фоновые работники** (`anpr/workers/channel_worker.py`) запускают `asyncio`-цикл внутри `QThread`: чтение кадра, трекинг,  OCR и запись в БД выполняются через `asyncio.to_thread`, поэтому обработка нескольких каналов не блокирует друг друга и UI.
- **Детекторы и OCR** теперь изолированы: `anpr/detection/yolo_detector.py` отвечает только за детекцию/трекинг номеров, `anpr/recognition/crnn_recognizer.py` — за OCR, `anpr/pipeline/anpr_pipeline.py` агрегирует результаты. `anpr/pipeline/factory.py` собирает компоненты без привязки к UI, а конфигурация путей вынесена в `anpr/config.py`.
- **Сервисные компоненты** (`anpr_cli.py`, `storage.py`, `settings_manager.py`, `logging_manager.py`) предоставляют независимые обязанности по принципам SOLID/DRY/KISS.

### Детекция и трекинг
- **YOLOv8** используется для поиска номерных знаков на кадре. Порог уверенности настраивается в `ModelConfig.DETECTION_CONFIDENCE_THRESHOLD` (`anpr/config.py`).
- Для видео применяется метод `track(...)` с включённым `persist=True`, что позволяет привязывать обнаружения к ID трека. При любой ошибке или отсутствии зависимостей трекера происходит **автоматический откат к чистой детекции**, чтобы не ломать поток на нескольких каналах.
- Чтобы избежать просадки FPS при срабатывании детектора движения, в настройках канала можно задать **шаг инференса детектора** (каждый N-й кадр) — YOLO запускается реже, продолжая использовать трекинг, что разгружает CPU/GPU.

### Детекция движения и запуск пайплайна
- Каждый канал имеет режим **«Обнаружение ТС: Постоянное / Детектор движения»**. В режиме детектора движение ищется только внутри настроенной ROI.
- Обработка кадров стала адаптивной: можно считать движение только на каждом N-м кадре, задавать минимальное число кадров с движением для запуска распознавания и минимальное число кадров без движения для его остановки.
- Порог чувствительности к площади изменения ROI настраивается через меню «Настройки → Детектор движения».
- Архитектура: `Кадр -> детектор движения -> (движение?) -> YOLO -> CRNN`. При отсутствии движения переход к детекции номеров не выполняется, что снижает нагрузку на CPU/GPU для многоканального ввода.

### OCR
- **CRNN** (INT8, квантизованный через `torch.ao.quantization.quantize_fx`) считывает символы с кропа номерной пластины и возвращает **уверенность OCR** (0..1) для декодированного текста.
- Перед распознаванием выполняется препроцессинг: перевод в градации серого, подавление шума, бинаризация и попытка **коррекции перспективы** по четырём углам контура, что повышает читабельность наклонённых номеров.
- Результаты ниже порога `tracking.ocr_min_confidence` автоматически помечаются как «нечитаемо» и не попадают в события, снижая шанс ложных срабатываний.

### Агрегация по треку (Track-based Recognition Aggregation)
- Для каждого ID трека собирается буфер из N «бестшотов» (`tracking.best_shots`).
- По накопленным результатам запускается **голосование**: вариант, встречающийся чаще всего и собравший кворум, принимается как консенсусный и фиксируется только один раз per track.
- Это снижает шум и убирает дубли, так как единичные ошибки OCR не проходят в итоговый поток событий.

### Подавление повторов (Cooldown)
- После фиксации номера включается таймер подавления (`tracking.cooldown_seconds`), в течение которого тот же текст не будет эмитироваться повторно даже при новых появлениях в кадре.
- Кулдаун применяется после агрегации, поэтому не мешает набору бестшотов, но предотвращает «заливку» базы одинаковыми событиями.

### Хранилище и события
- События сохраняются в локальную SQLite-базу проекта (`data/db/anpr.db` по умолчанию, путь выбирается в общих настройках) через модуль `storage.py` (паттерн Repository). Таблица `events` хранит номер, канал, путь к кадру/кропу и **UTC-время** события.
- Фоновая обработка использует **асинхронный клиент** `AsyncEventDatabase` на базе `aiosqlite`, чтобы не задерживать видеопоток при записи. При смене директории БД она автоматически создаётся вместе с необходимой схемой.
- Главный GUI поток получает новые события из каналов, обновляет виджет «Последнее событие» и таблицу «События» (100 последних). Фильтры и поиск работают напрямую с БД.

### Настройки и расширяемость
- Все параметры (пути к моделям/БД, каналы, сетка, `tracking.best_shots`, `tracking.cooldown_seconds`, `tracking.ocr_min_confidence`, частота инференса детектора, авто-переподключение) лежат в `settings.json` и управляются через `settings_manager.py`. Папка БД и папка для скриншотов задаются в разделе «Общие настройки» и создаются автоматически.
- Параметры каналов независимы: источник (RTSP/файл), имя, ROI распознавания, режим детекции движения, консенсус по бестшотам и пороги распознавания задаются отдельно для каждой камеры.
- Авто-переподключение включает два режима: восстановление при потере сигнала (таймаут ожидания кадра и интервал между попытками) и плановое переподключение каждые N минут — оба параметра настраиваются в разделе «Общие настройки».
- Приложение разделено на независимые компоненты (детектор, OCR, пайплайн агрегации, GUI-слой, хранилище), что упрощает поддержку и соответствует принципам **SOLID/DRY/KISS и ООП**: отдельные классы отвечают за загрузку моделей, агрегацию, работу потоков и доступ к данным.

### Диаграмма процесса распознавания

```mermaid
flowchart LR
    A[Видеопоток с камеры] --> B(Детекция<br>и трекинг)
    B --> C[Выбор лучших кадров<br>(бестшотов)]
    C --> D[Распознавание атрибутов<br>(OCR CRNN)]
    D --> E{Агрегация<br>результатов по треку}
    E --> F[Подавление повторов<br>(cooldown)]
    F --> G[Сохранение события<br>в БД + скриншоты]
    G --> H[Отображение в UI<br>и поиск]
```

### Логирование
- `LoggingManager` настраивает единый стек логов (консоль + файл) с ротацией через `RotatingFileHandler`.
- Параметры (`logging.level`, `logging.file`, `logging.max_bytes`, `logging.backup_count`) задаются в `settings.json`.
- Ключевые события пайплайна (запуск каналов, ошибки трекера, сохранение распознанных номеров) фиксируются именованными логгерами.

## Обзор .py файлов

- `app.py` — точка входа, инициализация логирования/настроек и запуск основного окна.
- `anpr_cli.py` — CLI для единичного распознавания изображений или видео с визуализацией результата.
- `logging_manager.py` — настройка ротации и уровней логов, единый доступ к именованным логгерам.
- `settings_manager.py` — загрузка/обновление `settings.json`, управление директориями БД и скриншотов, дефолты каналов и трекинга.
- `storage.py` — синхронный (`EventDatabase`) и асинхронный (`AsyncEventDatabase`) репозитории SQLite, создающие таблицу `events` в проектной БД.
- `anpr/config.py` — константы путей моделей и параметров по умолчанию (например, устройство инференса).
- `anpr/__init__.py` — инициализация пакета ANPR.
- `anpr/detection/__init__.py` — точка импорта детекторов.
- `anpr/detection/motion_detector.py` — детекция движения с управлением порогами, шагом кадров и гистерезисом включения/выключения.
- `anpr/detection/yolo_detector.py` — обёртка YOLOv8 для детекции/трекинга номерных знаков, обработка откатов на детекцию.
- `anpr/pipeline/__init__.py` — инициализация пайплайна распознавания.
- `anpr/pipeline/anpr_pipeline.py` — склейка детектов, бестшотов и OCR-результатов, логика агрегации по треку.
- `anpr/pipeline/factory.py` — сборка пайплайна, детектора и OCR с ленивой инициализацией шареного распознавателя.
- `anpr/recognition/__init__.py` — инициализация модуля распознавания.
- `anpr/recognition/crnn.py` — архитектура CRNN, определение forward-прохода.
- `anpr/recognition/crnn_recognizer.py` — загрузка квантизованной CRNN, препроцессинг и декодирование OCR.
- `anpr/ui/__init__.py` — инициализация UI-пакета.
- `anpr/ui/main_window.py` — PyQt5-интерфейс: вкладки наблюдения, поиска, настроек; запуск потоков каналов и работа с БД/скриншотами.
- `anpr/workers/__init__.py` — инициализация пакета фоновых работ.
- `anpr/workers/channel_worker.py` — `QThread` + `asyncio`-цикл захвата, детекции, OCR, сохранения событий и скриншотов.
